"""
–¢–∏–ø—ã –ø–æ—Å—Ç–æ–≤ –∏ —Ä–æ—Ç–∞—Ü–∏—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ "3 –∫–∏—Ç–∞"
"""
import json
import random
from pathlib import Path
from datetime import datetime
from typing import Tuple

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–æ—Ç–∞—Ü–∏–∏
STATE_FILE = Path(__file__).parent.parent.parent / "data" / "post_rotation.json"


# –ü—É–ª CTA-—Ç–µ–∫—Å—Ç–æ–≤ (–≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Ä–∞–Ω–¥–æ–º–Ω–æ)
CTA_POOL = [
    "üí° –ù—É–∂–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞? –û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É ‚Üí https://t.me/smart_analytics_mp_bot",
    "üìä –•–æ—Ç–∏—Ç–µ —Ç–∞–∫–∏–µ –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã? –û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É ‚Üí https://t.me/smart_analytics_mp_bot",
    "üí¨ –ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã? –ù–∞–ø–∏—à–∏—Ç–µ –≤ –±–æ—Ç ‚Üí https://t.me/smart_analytics_mp_bot",
    "üì≤ –û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É ‚Üí https://t.me/smart_analytics_mp_bot"
]

# –¢–∏–ø—ã –ø–æ—Å—Ç–æ–≤
POST_TYPES = {
    "useful": {
        "name": "–ü–æ–ª–µ–∑–Ω–∞—è –ø–æ–ª—å–∑–∞",
        "description": "–†–∞–∑–±–æ—Ä API, —Ñ–∏—à–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏, –∫–∞–∫ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å",
        "frequency": 2,  # 2 —Ä–∞–∑–∞ –≤ —Ü–∏–∫–ª–µ
        "prompt_addition": """
–¢–ò–ü –ü–û–°–¢–ê: –ü–û–õ–ï–ó–ù–ê–Ø –ü–û–õ–¨–ó–ê (–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –≥–∞–π–¥)

–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–æ–ª—å–∑–æ–π:
- –†–∞–∑–±–æ—Ä –Ω–æ–≤–æ–≥–æ API –∏–ª–∏ –º–µ—Ç–æ–¥–∞
- –§–∏—à–∫–∞ –≤ —Ä–∞–±–æ—Ç–µ —Å –¥–∞–Ω–Ω—ã–º–∏
- –ö–∞–∫ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –≤—Ä–µ–º—è/–¥–µ–Ω—å–≥–∏
- –õ–∞–π—Ñ—Ö–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

–§–æ—Ä–º–∞—Ç: –ü—Ä–æ–±–ª–µ–º–∞ ‚Üí –†–µ—à–µ–Ω–∏–µ ‚Üí –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å
"""
    },
    "case": {
        "name": "–ö–µ–π—Å/–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ",
        "description": "–†–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å —Ü–∏—Ñ—Ä–∞–º–∏",
        "frequency": 1,  # 1 —Ä–∞–∑ –≤ —Ü–∏–∫–ª–µ
        "prompt_addition": """
–¢–ò–ü –ü–û–°–¢–ê: –ö–ï–ô–° –° –¶–ò–§–†–ê–ú–ò (–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã)

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
1. –î—Ä–∞–º–∞—Ç–∏—á–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Ü–∏—Ñ—Ä–æ–π ("–ö–∞–∫ –∫–ª–∏–µ–Ω—Ç —Ç–µ—Ä—è–ª 300–ö –≤ –º–µ—Å—è—Ü")
2. –°–∏—Ç—É–∞—Ü–∏—è: —á—Ç–æ –±—ã–ª–æ –Ω–µ —Ç–∞–∫ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
3. –ß—Ç–æ –Ω–∞—à–ª–∏: –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã
4. –†–µ—à–µ–Ω–∏–µ: —á—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–ª–∏/–Ω–∞—Å—Ç—Ä–æ–∏–ª–∏
5. –†–µ–∑—É–ª—å—Ç–∞—Ç: —Ü–∏—Ñ—Ä—ã —ç–∫–æ–Ω–æ–º–∏–∏ –∏–ª–∏ —É–ª—É—á—à–µ–Ω–∏—è

–§–æ—Ä–º–∞—Ç: –ë—ã–ª–æ –ø–ª–æ—Ö–æ (—Å —Ü–∏—Ñ—Ä–æ–π) ‚Üí –ù–∞—à–ª–∏ –ø—Ä–∏—á–∏–Ω—É ‚Üí –°–¥–µ–ª–∞–ª–∏ ‚Üí –°—Ç–∞–ª–æ —Ö–æ—Ä–æ—à–æ (—Å —Ü–∏—Ñ—Ä–æ–π)
"""
    },
    "interactive": {
        "name": "–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤/–ú–Ω–µ–Ω–∏–µ",
        "description": "–¢–≤–æ—ë –º–Ω–µ–Ω–∏–µ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å –∞—É–¥–∏—Ç–æ—Ä–∏–∏",
        "frequency": 1,  # 1 —Ä–∞–∑ –≤ —Ü–∏–∫–ª–µ
        "prompt_addition": """
–¢–ò–ü –ü–û–°–¢–ê: –ò–ù–¢–ï–†–ê–ö–¢–ò–í (–≤–æ–≤–ª–µ—á–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏)

–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç —Å —Ç–≤–æ–∏–º –º–Ω–µ–Ω–∏–µ–º –∏–ª–∏ –≤–æ–ø—Ä–æ—Å–æ–º:
- –¢–≤–æ–π –≤–∑–≥–ª—è–¥ –Ω–∞ –Ω–æ–≤–æ—Å—Ç—å/–∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞
- –°–ø–æ—Ä–Ω–æ–µ –º–Ω–µ–Ω–∏–µ (–Ω–æ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–µ)
- –í–æ–ø—Ä–æ—Å –∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –≤ –∫–æ–Ω—Ü–µ
- –ü—Ä–∏–∑—ã–≤ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º

–§–æ—Ä–º–∞—Ç: –ù–æ–≤–æ—Å—Ç—å/–§–∞–∫—Ç ‚Üí –¢–≤–æ—ë –º–Ω–µ–Ω–∏–µ ‚Üí –í–æ–ø—Ä–æ—Å –∞—É–¥–∏—Ç–æ—Ä–∏–∏
"""
    },
    "checklist": {
        "name": "–ß–µ–∫-–ª–∏—Å—Ç",
        "description": "–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –∏–ª–∏ –ø—É–Ω–∫—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏",
        "frequency": 1,
        "prompt_addition": """
–¢–ò–ü –ü–û–°–¢–ê: –ß–ï–ö-–õ–ò–°–¢

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
1. –ó–∞–≥–æ–ª–æ–≤–æ–∫: "N –∑–∞–¥–∞—á/–ø—É–Ω–∫—Ç–æ–≤ –¥–ª—è [—Ü–µ–ª—å]"
2. –ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ (5-7 –ø—É–Ω–∫—Ç–æ–≤)
3. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç: –¥–µ–π—Å—Ç–≤–∏–µ + –∑–∞—á–µ–º —ç—Ç–æ –≤–∞–∂–Ω–æ (–∫—Ä–∞—Ç–∫–æ)
4. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: "–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ, –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è" –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–µ

–ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞:
‚úÖ –§–µ–≤—Ä–∞–ª—å—Å–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç —Å–µ–ª–ª–µ—Ä–∞:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∏–Ω–∞–º–∏–∫—É –ø—Ä–æ–¥–∞–∂ ‚Äî –ø–æ–Ω—è—Ç—å —Ç—Ä–µ–Ω–¥
2. –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã ‚Äî —É—á–µ—Å—Ç—å –∏–Ω—Ñ–ª—è—Ü–∏—é
...
"""
    },
    "tools": {
        "name": "–û–±–∑–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤",
        "description": "–¢–æ–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∑–∞–¥–∞—á–∏",
        "frequency": 1,
        "prompt_addition": """
–¢–ò–ü –ü–û–°–¢–ê: –û–ë–ó–û–† –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
1. –ó–∞–≥–æ–ª–æ–≤–æ–∫: "–¢–æ–ø-N –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è [–∑–∞–¥–∞—á–∞]"
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:
   - –ù–∞–∑–≤–∞–Ω–∏–µ
   - –î–ª—è —á–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç
   - –ü–ª—é—Å –∏ –º–∏–Ω—É—Å (–∫—Ä–∞—Ç–∫–æ)
3. –¢–≤–æ—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –∫–∞–∫–æ–π –≤—ã–±—Ä–∞—Ç—å –Ω–æ–≤–∏—á–∫—É/–æ–ø—ã—Ç–Ω–æ–º—É

–§–æ—Ä–º–∞—Ç: —Å–ø–∏—Å–æ–∫ —Å –∫—Ä–∞—Ç–∫–∏–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏, –ª–∏—á–Ω–æ–µ –º–Ω–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ü–µ
"""
    },
    "mistake": {
        "name": "–ò—Å—Ç–æ—Ä–∏—è –æ—à–∏–±–∫–∏",
        "description": "–î—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å —É—Ä–æ–∫–æ–º",
        "frequency": 1,
        "prompt_addition": """
–¢–ò–ü –ü–û–°–¢–ê: –ò–°–¢–û–†–ò–Ø –û–®–ò–ë–ö–ò (storytelling)

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
1. –î—Ä–∞–º–∞—Ç–∏—á–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ ("–û—à–∏–±–∫–∞ –≤ 500–ö", "–ö–∞–∫ –æ–¥–∏–Ω SKU —É–±–∏–ª –ø—Ä–∏–±—ã–ª—å")
2. –ó–∞–≤—è–∑–∫–∞: –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏—à—ë–ª —Å –ø—Ä–æ–±–ª–µ–º–æ–π (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
3. –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ: –∫–∞–∫ –∏—Å–∫–∞–ª–∏ –ø—Ä–∏—á–∏–Ω—É
4. –ö—É–ª—å–º–∏–Ω–∞—Ü–∏—è: —á—Ç–æ –æ–∫–∞–∑–∞–ª–æ—Å—å –Ω–µ —Ç–∞–∫ (–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç)
5. –£—Ä–æ–∫: –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –¥—Ä—É–≥–∏–º (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)

–§–æ—Ä–º–∞—Ç: –º–∏–Ω–∏-–∏—Å—Ç–æ—Ä–∏—è —Å –¥—Ä–∞–º–∞—Ç—É—Ä–≥–∏–µ–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –ø–æ—Ç–µ—Ä—å
"""
    }
}

# –ü–æ—Ä—è–¥–æ–∫ —Ä–æ—Ç–∞—Ü–∏–∏: –ø–æ–ª–µ–∑–Ω–æ, –ø–æ–ª–µ–∑–Ω–æ, –∫–µ–π—Å, –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤
ROTATION_ORDER = ["useful", "useful", "case", "interactive"]


def get_state() -> dict:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–æ—Ç–∞—Ü–∏–∏"""
    STATE_FILE.parent.mkdir(parents=True, exist_ok=True)

    if STATE_FILE.exists():
        with open(STATE_FILE, "r") as f:
            return json.load(f)

    return {"current_index": 0, "last_post_date": None, "history": []}


def save_state(state: dict):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–æ—Ç–∞—Ü–∏–∏"""
    STATE_FILE.parent.mkdir(parents=True, exist_ok=True)
    with open(STATE_FILE, "w") as f:
        json.dump(state, f, indent=2, default=str)


def can_publish() -> Tuple[bool, str]:
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–Ω–æ –ª–∏ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π)
    –ú–∏–Ω–∏–º—É–º 6 —á–∞—Å–æ–≤ –º–µ–∂–¥—É –ø–æ—Å—Ç–∞–º–∏

    Returns:
        (can_publish, reason)
    """
    state = get_state()
    last_post = state.get("last_post_date")

    if not last_post:
        return True, "OK"

    from datetime import datetime, timedelta

    last_post_time = datetime.fromisoformat(last_post)
    min_interval = timedelta(hours=6)

    if datetime.now() - last_post_time < min_interval:
        time_left = min_interval - (datetime.now() - last_post_time)
        hours_left = time_left.total_seconds() / 3600
        return False, f"–°–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â—ë {hours_left:.1f} —á–∞—Å–æ–≤"

    return True, "OK"


def should_add_cta() -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å CTA –≤ —ç—Ç–æ—Ç –ø–æ—Å—Ç
    –î–æ–±–∞–≤–ª—è–µ–º –≤ 2 –ø–æ—Å—Ç–∞—Ö –∏–∑ 3 (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–∂–¥—ã–π —Ç—Ä–µ—Ç–∏–π)

    Returns:
        True –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å CTA
    """
    state = get_state()
    # –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
    total_posts = len(state.get("history", []))

    # –î–æ–±–∞–≤–ª—è–µ–º CTA –≤–æ –≤—Å–µ –ø–æ—Å—Ç—ã –ö–†–û–ú–ï –∫–∞–∂–¥–æ–≥–æ —Ç—Ä–µ—Ç—å–µ–≥–æ
    # total_posts + 1 –ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –ø–ª–∞–Ω–∏—Ä—É–µ–º –°–õ–ï–î–£–Æ–©–ò–ô –ø–æ—Å—Ç
    position = (total_posts % 3) + 1
    return position != 3


def should_add_personal_experience() -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç –≤ —ç—Ç–æ—Ç –ø–æ—Å—Ç
    –î–æ–±–∞–≤–ª—è–µ–º –≤ 1 –ø–æ—Å—Ç–µ –∏–∑ 4 (–∫–∞–∂–¥—ã–π 4-–π –ø–æ—Å—Ç)

    Returns:
        True –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç
    """
    state = get_state()
    # –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
    total_posts = len(state.get("history", []))

    # –î–æ–±–∞–≤–ª—è–µ–º –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç –≤ –∫–∞–∂–¥—ã–π 4-–π –ø–æ—Å—Ç (–ø–æ–∑–∏—Ü–∏–∏ 4, 8, 12, 16...)
    # total_posts + 1 –ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –ø–ª–∞–Ω–∏—Ä—É–µ–º –°–õ–ï–î–£–Æ–©–ò–ô –ø–æ—Å—Ç
    position = (total_posts % 4) + 1
    return position == 4


def get_next_post_type() -> Tuple[str, dict]:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Ç–∏–ø –ø–æ—Å—Ç–∞ –ø–æ —Ä–æ—Ç–∞—Ü–∏–∏

    Returns:
        (post_type_key, post_type_config)
    """
    state = get_state()
    current_index = state.get("current_index", 0)

    # –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –ø–æ—Å—Ç–∞ –∏–∑ —Ä–æ—Ç–∞—Ü–∏–∏
    post_type_key = ROTATION_ORDER[current_index % len(ROTATION_ORDER)]
    post_type_config = POST_TYPES[post_type_key].copy()

    # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥, –Ω—É–∂–Ω–æ –ª–∏ CTA
    post_type_config["add_cta"] = should_add_cta()

    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π CTA –∏–∑ –ø—É–ª–∞
    if post_type_config["add_cta"]:
        post_type_config["cta"] = random.choice(CTA_POOL)
    else:
        post_type_config["cta"] = ""

    # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç
    post_type_config["add_personal_experience"] = should_add_personal_experience()

    return post_type_key, post_type_config


def get_post_type_from_plan(post_type_key: str) -> Tuple[str, dict]:
    """
    –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞ –∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞.

    Args:
        post_type_key: –∫–ª—é—á —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞ (useful, case, checklist, etc.)

    Returns:
        (post_type_key, post_type_config)
    """
    if post_type_key not in POST_TYPES:
        # Fallback –Ω–∞ useful –µ—Å–ª–∏ —Ç–∏–ø –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω
        post_type_key = "useful"

    post_type_config = POST_TYPES[post_type_key].copy()

    # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥, –Ω—É–∂–Ω–æ –ª–∏ CTA
    post_type_config["add_cta"] = should_add_cta()

    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π CTA –∏–∑ –ø—É–ª–∞
    if post_type_config["add_cta"]:
        post_type_config["cta"] = random.choice(CTA_POOL)
    else:
        post_type_config["cta"] = ""

    return post_type_key, post_type_config


def mark_post_published(post_type_key: str):
    """–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å—Ç –∫–∞–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ç–∏–ø—É"""
    state = get_state()

    # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å
    state["current_index"] = (state.get("current_index", 0) + 1) % len(ROTATION_ORDER)
    state["last_post_date"] = datetime.now().isoformat()

    # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    if "history" not in state:
        state["history"] = []
    state["history"].append({
        "type": post_type_key,
        "date": datetime.now().isoformat()
    })
    # –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–∞–ø–∏—Å–µ–π
    state["history"] = state["history"][-20:]

    save_state(state)


def get_random_publish_time() -> Tuple[int, int]:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –º–µ–∂–¥—É 09:00 –∏ 12:00

    Returns:
        (hour, minute)
    """
    hour = random.randint(9, 11)
    minute = random.randint(0, 59)
    return hour, minute


def get_rotation_status() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å —Ä–æ—Ç–∞—Ü–∏–∏"""
    state = get_state()
    current_index = state.get("current_index", 0)
    next_type_key = ROTATION_ORDER[current_index % len(ROTATION_ORDER)]
    next_type = POST_TYPES[next_type_key]

    status = f"""üìä –°—Ç–∞—Ç—É—Å —Ä–æ—Ç–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤:

–°–ª–µ–¥—É—é—â–∏–π —Ç–∏–ø: {next_type['name']}
–ü–æ–∑–∏—Ü–∏—è –≤ —Ü–∏–∫–ª–µ: {current_index % len(ROTATION_ORDER) + 1} –∏–∑ {len(ROTATION_ORDER)}

–¶–∏–∫–ª —Ä–æ—Ç–∞—Ü–∏–∏:
1. –ü–æ–ª–µ–∑–Ω–∞—è –ø–æ–ª—å–∑–∞
2. –ü–æ–ª–µ–∑–Ω–∞—è –ø–æ–ª—å–∑–∞
3. –ö–µ–π—Å
4. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤

–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Å—Ç: {state.get('last_post_date', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö')}
"""
    return status


if __name__ == "__main__":
    # –¢–µ—Å—Ç
    print("–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:")
    print(get_rotation_status())

    print("\n–°–ª–µ–¥—É—é—â–∏–µ 6 –ø–æ—Å—Ç–æ–≤:")
    for i in range(6):
        post_type_key, post_type = get_next_post_type()
        print(f"{i+1}. {post_type['name']}")
        mark_post_published(post_type_key)
