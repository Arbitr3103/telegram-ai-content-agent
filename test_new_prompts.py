"""
–¢–µ—Å—Ç –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–º–ø—Ç–æ–≤ (–ë–ï–ó –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Telegram)
"""
import asyncio
import os
import sys

sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from app.config import settings
from app.agents.content_generator import ContentGenerator
from app.utils.post_types import get_post_type_from_plan
from app.utils.content_plan import get_content_plan


async def main():
    print("""
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë     –¢–ï–°–¢ –ù–û–í–û–ô –°–ò–°–¢–ï–ú–´ –ü–†–û–ú–ü–¢–û–í                           ‚ïë
    ‚ïë     (–±–µ–∑ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Telegram)                           ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    """)

    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω
    print("üìÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞...")
    content_plan = get_content_plan()
    all_posts = content_plan.get_all_posts()

    print(f"   –í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤ –≤ –ø–ª–∞–Ω–µ: {len(all_posts)}")

    # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç –∏–∑ –ø–ª–∞–Ω–∞ (5 —Ñ–µ–≤—Ä–∞–ª—è ‚Äî –∫–µ–π—Å)
    if all_posts:
        planned_post = all_posts[0]
        print(f"\nüìã –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ—Å—Ç:")
        print(f"   –î–∞—Ç–∞: {planned_post.date}")
        print(f"   –¢–∏–ø: {planned_post.type}")
        print(f"   –¢–µ–º–∞: {planned_post.topic}")
        print(f"   Keywords: {planned_post.keywords}")
    else:
        print("‚ùå –ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω –ø—É—Å—Ç!")
        return

    # 2. –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞
    post_type_key, post_type_config = get_post_type_from_plan(planned_post.type)
    print(f"\n‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:")
    print(f"   post_type_key: {post_type_key}")
    print(f"   CTA: {'–î–∞' if post_type_config.get('add_cta') else '–ù–µ—Ç'}")
    print(f"   –õ–∏—á–Ω—ã–π –æ–ø—ã—Ç: {'–î–∞' if post_type_config.get('add_personal_experience') else '–ù–µ—Ç'}")

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º topic_instruction (–∫–∞–∫ –≤ main.py)
    topic_instruction = f"""
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –¢–ï–ú–ê –ü–û–°–¢–ê!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

–¢–ï–ú–ê: {planned_post.topic}

üö´ –ó–ê–ü–†–ï–©–ï–ù–û:
‚Ä¢ –ü–∏—Å–∞—Ç—å –ø—Ä–æ API, –µ—Å–ª–∏ —Ç–µ–º–∞ –ù–ï –ø—Ä–æ API
‚Ä¢ –ü–∏—Å–∞—Ç—å –ø—Ä–æ "–Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏", –µ—Å–ª–∏ —Ç–µ–º–∞ –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–µ–π—Å
‚Ä¢ –û—Ç–∫–ª–æ–Ω—è—Ç—å—Å—è –æ—Ç —Ç–µ–º—ã –Ω–∏ –Ω–∞ —Å–ª–æ–≤–æ
‚Ä¢ –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –Ω–∏–∂–µ

‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
‚Ä¢ –ü–æ—Å—Ç –¢–û–õ–¨–ö–û –Ω–∞ —Ç–µ–º—É –≤—ã—à–µ
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {', '.join(planned_post.keywords)}
"""
    if planned_post.structure:
        topic_instruction += f"""
–°–¢–†–£–ö–¢–£–†–ê –ü–û–°–¢–ê (—Å–ª–µ–¥—É–π –µ–π!):
{planned_post.structure}
"""
    topic_instruction += """
–ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —Ç–µ–º–µ ‚Äî –ø—Ä–∏–¥—É–º–∞–π –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã–π –∫–µ–π—Å —Å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏.
–ù–ï –ü–ï–†–ï–ö–õ–Æ–ß–ê–ô–°–Ø –Ω–∞ –¥—Ä—É–≥—É—é —Ç–µ–º—É! –ü–ò–®–ò –°–¢–†–û–ì–û –ü–û –¢–ï–ú–ï!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
"""

    print(f"\nüìù Topic instruction —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω ({len(topic_instruction)} —Å–∏–º–≤–æ–ª–æ–≤)")

    # 4. –°–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (—á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç Exa API)
    sources = [
        {
            'title': '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —É—á–µ—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –Ω–∞ Wildberries',
            'content': '–°–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤–æ–∑–≤—Ä–∞—Ç–∞–º –ø–æ–º–æ–≥–∞—é—Ç —Å–µ–ª–ª–µ—Ä–∞–º –≤—ã—è–≤–ª—è—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ SKU –∏ —Å–Ω–∏–∂–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—Ç–æ–≤.',
            'url': 'https://example.com',
            'source_type': 'article'
        }
    ]
    print(f"\nüì° –ò—Å—Ç–æ—á–Ω–∏–∫–∏: {len(sources)} (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–ª—è —Ç–µ—Å—Ç–∞)")

    # 5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ—Å—Ç
    print("\n‚úçÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ —á–µ—Ä–µ–∑ Claude...")
    print("   (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥)\n")

    generator = ContentGenerator()

    try:
        post = await generator.generate_post(
            sources,
            post_type_key=post_type_key,
            topic_instruction=topic_instruction,
            add_cta=post_type_config.get('add_cta', False),
            cta_text=post_type_config.get('cta', ''),
            add_personal_experience=post_type_config.get('add_personal_experience', False)
        )

        print("=" * 60)
        print("üìù –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ô –ü–û–°–¢:")
        print("=" * 60)
        print(post['content'])
        print("=" * 60)
        print(f"\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        print(f"   –î–ª–∏–Ω–∞: {len(post['content'])} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"   –¢–µ–≥–∏: {post.get('tags', [])}")

        # –ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
        print("\n‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞:")
        content = post['content']

        # –≠–º–æ–¥–∑–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        if content[0] in 'üìäüõ†Ô∏è‚ö°üí¨üò±‚úÖ‚ùìüîß':
            print("   ‚úì –≠–º–æ–¥–∑–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ")
        else:
            print("   ‚úó –ù–ï–¢ —ç–º–æ–¥–∑–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ!")

        # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        if '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ' in content:
            print("   ‚úì –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –µ—Å—Ç—å")
        else:
            print("   ‚úó –ù–ï–¢ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è!")

        # –í–æ–ø—Ä–æ—Å –∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
        if '?' in content and 'üëá' in content:
            print("   ‚úì –í–æ–ø—Ä–æ—Å –∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ + üëá")
        else:
            print("   ‚úó –ù–ï–¢ –≤–æ–ø—Ä–æ—Å–∞ –∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏!")

        # –•–µ—à—Ç–µ–≥–∏
        if '#' in content:
            print("   ‚úì –•–µ—à—Ç–µ–≥–∏ –µ—Å—Ç—å")
        else:
            print("   ‚úó –ù–ï–¢ —Ö–µ—à—Ç–µ–≥–æ–≤!")

        # –¶–∏—Ñ—Ä—ã
        import re
        numbers = re.findall(r'\d+[%‚ÇΩ–ö–∫M–ú]|\d{2,}', content)
        if len(numbers) >= 2:
            print(f"   ‚úì –¶–∏—Ñ—Ä—ã –µ—Å—Ç—å ({len(numbers)} —à—Ç—É–∫)")
        else:
            print(f"   ‚úó –ú–∞–ª–æ —Ü–∏—Ñ—Ä ({len(numbers)} —à—Ç—É–∫)!")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ API
        if 'API' in content and '–≤–æ–∑–≤—Ä–∞—Ç' not in content.lower():
            print("   ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ü–æ—Å—Ç –ø—Ä–æ API, —Ö–æ—Ç—è —Ç–µ–º–∞ –ø—Ä–æ –≤–æ–∑–≤—Ä–∞—Ç—ã!")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    asyncio.run(main())
